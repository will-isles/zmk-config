name: Build ZMK firmware
on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    uses: zmkfirmware/zmk/.github/workflows/build-user-config.yml@v0.3

  rename-artifacts:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*"
          merge-multiple: false
          path: artifacts

      - name: Generate timestamp
        id: timestamp
        run: |
          TIMESTAMP=$(date -u +'%Y-%m-%d-%H-%M-%S')
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

      - name: Rename firmware artifacts
        run: |
          TIMESTAMP="${{ steps.timestamp.outputs.timestamp }}"
          cd artifacts

          # Debug: List directory structure
          echo "Artifact directory structure:"
          find . -type f -name "*.zip" | head -20
          echo "---"

          # Create output directory for renamed files
          mkdir -p ../renamed

          # Find all zip files recursively
          find . -name "*.zip" -type f | while IFS= read -r zipfile; do
            # Get the directory containing the zip file
            zipdir=$(dirname "$zipfile")
            filename=$(basename "$zipfile")
            
            # Determine variant from path and filename
            variant=""
            if echo "$zipfile" | grep -qi "dongle"; then
              variant="dongle"
            elif echo "$zipfile" | grep -qi "left"; then
              variant="left"
            elif echo "$zipfile" | grep -qi "right"; then
              variant="right"
            elif echo "$zipfile" | grep -qi "settings.*reset"; then
              if echo "$zipfile" | grep -qi "xiao"; then
                variant="settings-reset-xiao"
              elif echo "$zipfile" | grep -qi "nice.*nano"; then
                variant="settings-reset-nice-nano"
              else
                variant="settings-reset"
              fi
            else
              # Use sanitized filename (without .zip extension) as variant
              variant=$(echo "$filename" | sed 's/\.zip$//' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
            fi
            
            if [ -n "$variant" ]; then
              # Create new filename
              newname="aurora-${variant}-${TIMESTAMP}.zip"
              
              # Copy to renamed directory
              cp "$zipfile" "../renamed/$newname"
              echo "Renamed: $zipfile -> $newname"
            else
              echo "Warning: Could not determine variant for $zipfile"
            fi
          done

      - name: Upload renamed artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-timestamped
          path: renamed/*.zip
          retention-days: 90
