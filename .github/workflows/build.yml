name: Build ZMK firmware
on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    uses: zmkfirmware/zmk/.github/workflows/build-user-config.yml@v0.3

  rename-artifacts:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*"
          merge-multiple: false
          path: artifacts

      - name: Generate timestamp
        id: timestamp
        run: |
          TIMESTAMP=$(date -u +'%Y-%m-%d-%H-%M-%S')
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

      - name: Rename firmware artifacts
        run: |
          TIMESTAMP="${{ steps.timestamp.outputs.timestamp }}"
          cd artifacts

          # Process each artifact directory
          for artifact_dir in */; do
            # Get artifact name (directory name without trailing slash)
            artifact_name="${artifact_dir%/}"
            
            # Find the zip file in this artifact directory
            zipfile=$(find "$artifact_dir" -maxdepth 1 -name "*.zip" -type f | head -n 1)
            
            if [ -n "$zipfile" ]; then
              # Determine variant from artifact name
              if echo "$artifact_name" | grep -qi "dongle"; then
                variant="dongle"
              elif echo "$artifact_name" | grep -qi "left"; then
                variant="left"
              elif echo "$artifact_name" | grep -qi "right"; then
                variant="right"
              elif echo "$artifact_name" | grep -qi "settings.*reset"; then
                if echo "$artifact_name" | grep -qi "xiao"; then
                  variant="settings-reset-xiao"
                elif echo "$artifact_name" | grep -qi "nice.*nano"; then
                  variant="settings-reset-nice-nano"
                else
                  variant="settings-reset"
                fi
              else
                # Use sanitized artifact name as variant
                variant=$(echo "$artifact_name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
              fi
              
              # Rename the zip file
              newname="aurora-${variant}-${TIMESTAMP}.zip"
              mv "$zipfile" "$artifact_dir/$newname"
              echo "Renamed: $zipfile -> $newname"
            fi
          done

      - name: Upload renamed artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-timestamped
          path: artifacts/**/*.zip
          retention-days: 90
